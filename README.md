# Тестовое задание для стажировки в VK Tech на позиции Backend Developer

## Чат-бот для голосования внутри чатов мессенджера Mattermost

Язык программирования: **Go**  
База данных: **tarantool**

### Логирование
Действия логируются с помощью пакета `log/slog`.
Также если выбрать в конфигурации среду `local`, будет использован [пакет-обёртка](https://github.com/Exc0mmun1cad0/badaslog) для более красивых логов.

### Конфигурация
#### Бот
Пример конфигурации лежит в файле `.env.example`. Её нужно скопировать в `.env` командой:
```bash
cp .env.example .env
```
В панели **Mattermost** в разделе `Integrations` во вкладке `Bot Accounts` создать нового бота.
> [!IMPORTANT]
> При создании скопировать токен бота в `.env` и добавить бота в команду. Название команды тоже вставить в `.env`.
#### Окружение
Переменная `ENV` определяет окружение, в котором запускается бот. От неё зависит формат выводимых логов. Может принимать значения:
- `local`
- `dev`
- `prod`
#### БД (Tarantool)
По умолчанию стоит пользователь с логином "sampleuser" и паролем "123456". При желании можно сменить, при этом также внести изменения в конфигурацию бд в файле `./tarantool/instances.enabled/bot/instances.yml`
Аналогично с портом. По умолчанию стоит ``3301. 
### Настройка dev-окружения
Для запуска бота необходим рабочий Mattermost-сервер с бд Postgres.  
Также нужно поднять бд **Tarantool**, которую использует бот.  
Следующие команды:
```bash
cd mattermost
mkdir -p ./volumes/app/mattermost/{config,data,logs,plugins,client/plugins,bleve-indexes}
sudo chown -R 2000:2000 ./volumes/app/mattermost
docker compose up -d
```
поднимают локально сервер **Mattermost** по адресу `localhost:8065` и сервер **Postgres**.  
> [!IMPORTANT]
> Перед запуском бота В конфигурацию **Mattermost** по пути `config/config.json` добавить поле `"AllowCorsFrom": "*"`
Для ***запуска самого бота***:
```
make bot-up
```
Данная команда с помощью `docker-compose.yml` собирает контейнер с приложением на **Go** и контейнер с бд **Tarantool**.


### Функционал
#### 1. Создание голосования
- Запрос:
```
!create_poll НАЗВАНИЕ_ОПРОСА
ВАРИАНТ 1
ВАРИАНТ 2
...
```
- Ответ при успешном выполнении:
```
New poll created: НАЗВАНИЕ_ОПРОСА
ID: ID_ГОЛОСОВАНИЯ
1) ВАРИАНТ 1
2) ВАРИАНТ 2
...
```
`ID` запроса будет использоваться в следующих командах  
Варианты нумеруются для более удобного голосования  
Если нужно создать опрос с ***несколькими вариантам*** ответов, то в запросе использовать `create_multipoll`

#### 2. Голосование
- Запрос:
```
!vote ID_ГОЛОСОВАНИЯ
ВАРИНТ(Ы)_ЧЕРЕЗ ПРОБЕЛ
```
- Ответ при успешном выполнении:
```
your vote was counted
```

#### 3. Просмотр результатов голосования
- Запрос:
```
!get_results ID_ГОЛОСОВАНИЯ
```
- Ответ при успешном выполнении:
```
Results:
1) КОЛИЧЕСТВО_ГОЛОСОВ
2) КОЛИЧЕСТВО_ГОЛОСОВ
...
```

#### 4. Завершение голосования  
Создатель голосования может завершить его.  
Можно будет только смотреть результаты голосования, но не голосовать или отменить голос.
- Запрос:
```
!finish_poll ID_ГОЛОСОВАНИЯ
```
- Ответ при успешном выполнении:
```
poll ID_ГОЛОСОВАНИЯ was finished
```

#### 5. Удаление голосования
Создатель голосования может удалить его.  
В таком случае все данные о нём, в том числе голоса и варианты ответов.  
При попытке запросить результаты будет выводиться сообщение что голосование не найдено.
- Запрос:
```
!delete-poll ID_ГОЛОСОВАНИЯ
```
- Ответ при успешном выполнении:
```
poll ID_ГОЛОСОВАНИЯ was deleted
```

#### Дополнительно. Отмена голоса
Если запрос ещё не закончен и пользователь уже проголосовал, у него есть возможность отменить голос.
- Запрос:
```
!retract_vote ID_ГОЛОСОВАНИЯ
```
- Ответ при успешном выполнении:
```
your vote was retracted
```